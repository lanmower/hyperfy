# Integration Plan: glootie-cc Features into Hyperfy

## WAVE 1 - Understanding & Setup (Independent, can execute in parallel)
- [ ] Analyze current CLAUDE.md structure and content (blocks: all integration tasks)
- [ ] Verify hyperfy doesn't have hooks directory yet (blocks: hooks creation)
- [ ] Check if hooks.json exists in hyperfy (blocks: hooks configuration)
- [ ] Identify where to document gm philosophy in CLAUDE.md (blocks: gm integration)

## WAVE 2 - Core Agent Policy Integration (Sequential after WAVE 1)
- [ ] Append gm agent policy (agents/gm.md) to CLAUDE.md under ## AGENT POLICY section
  - Decision: Add full gm.md content as-is (immutable philosophy required)
  - Integration point: After ## FILE STRUCTURE section
  - Verify: gm policy appears in CLAUDE.md complete and unchanged
  - Blocks: Everything that depends on gm philosophy being documented

## WAVE 3 - Hook Structure Setup (Sequential after WAVE 2)
- [ ] Create hooks/ directory in hyperfy root
- [ ] Create hooks/hooks.json with full glootie-cc hooks configuration
  - Content: All 5 hook types (SessionStart, Stop, Stop+Git, UserPromptSubmit, PreToolUse)
  - Timeout values: Keep same as glootie-cc (10s SessionStart, 300s+60s Stop, 3600s other)
  - Reference hooks: Use relative paths ../hooks/[name].js
  - Verify: JSON is valid and parseable
- [ ] Create hooks/.gitignore to keep directory tracked but ignore hook outputs
  - Blocks: Actual hook script creation

## WAVE 4 - Hook Script Implementation (Sequential after WAVE 3, mostly independent scripts)

### 4a - session-start-hook.js
- [ ] Create hooks/session-start-hook.js from glootie-cc source
  - Load gm.md from CLAUDE.md instead of agents/gm.md file
  - Parse CLAUDE.md to extract gm agent policy content (search for "# AGENT POLICY" or use regex)
  - Execute mcp-thorns with proper error handling (3min timeout, SIGTERM handling)
  - Build output with gm policy + thorns output
  - Support Claude, Gemini, OpenCode environments via env var detection
  - Verify: Hook executes, outputs valid JSON with additionalContext
  - Dependency: gm policy must be in CLAUDE.md
  - Blocks: Nothing (independent)

### 4b - stop-hook.js
- [ ] Create hooks/stop-hook.js from glootie-cc source
  - Read .prd file from project directory
  - Block stop if .prd exists with content (return decision: block)
  - Approve stop if .prd is empty or missing (return decision: approve)
  - Include full .prd content in block reason
  - Handle SIGTERM/SIGINT signals gracefully
  - Verify: Hook blocks on non-empty .prd, approves on empty/missing
  - Dependency: None (independent)
  - Blocks: Nothing (independent)

### 4c - stop-hook-git.js
- [ ] Create hooks/stop-hook-git.js from glootie-cc source
  - Check git repo status (may not be a git repo, handle gracefully)
  - Check for uncommitted changes (git status --porcelain)
  - Check for unpushed commits (git rev-list --count @{u}..HEAD)
  - Check for behind commits (git rev-list --count HEAD..@{u})
  - Block stop if any issues found (dirty, unpushed, behind)
  - Return detailed reason with issue list
  - Verify: Hook blocks on dirty/unpushed state, approves on clean
  - Dependency: None (independent)
  - Blocks: Nothing (independent)

### 4d - prompt-submit-hook.js
- [ ] Create hooks/prompt-submit-hook.js from glootie-cc source
  - Delete .glootie-stop-verified file if it exists (verification reset)
  - Add "always use gm sub agent for everything" to additionalContext
  - Support Claude, Gemini, OpenCode environments
  - Handle file deletion errors gracefully (not critical)
  - Verify: Hook runs without errors, deletes verification file
  - Dependency: None (independent)
  - Blocks: Nothing (independent)

### 4e - pre-tool-use-hook.js
- [ ] Create hooks/pre-tool-use-hook.js from glootie-cc source
  - Block Bash/shell tools → redirect to plugin:gm:dev
  - Block Write for test files → redirect to plugin:gm:dev
  - Block Write for non-critical docs → allow CLAUDE.md/readme.md only
  - Block Glob/Grep → redirect to gm:code-search or plugin:gm:dev
  - Block Task with Explore subagent → redirect to gm:thorns-overview
  - Read tool input as JSON from stdin
  - Support Claude, Gemini, OpenCode environments
  - Return deny with reason or allow decision
  - Verify: Hook properly blocks/allows based on tool type
  - Dependency: None (independent)
  - Blocks: Nothing (independent)

## WAVE 5 - Documentation Integration (Sequential after WAVE 4)
- [ ] Add HOOKS ARCHITECTURE section to CLAUDE.md explaining:
  - What each hook does (SessionStart, Stop, Stop+Git, UserPromptSubmit, PreToolUse)
  - When each hook fires
  - What .prd file controls (workflow state machine)
  - What verification file controls
  - Git enforcement requirements
- [ ] Add HOW TO USE GLOOTIE-CC section to CLAUDE.md with:
  - Create .prd at start of task with exhaustive items
  - Delete items from .prd as they complete (only deletion allowed)
  - Stop hook will block exit until .prd is empty
  - Git hook will block exit until changes are pushed
  - Session start provides gm policy + codebase overview via mcp-thorns
- [ ] Add TOOL REDIRECTS section to CLAUDE.md explaining:
  - Bash blocked → use plugin:gm:dev
  - Write (test files) blocked → use plugin:gm:dev
  - Glob/Grep blocked → use gm:code-search or plugin:gm:dev
  - Explore task blocked → use gm:thorns-overview

## WAVE 6 - Verify & Test (Sequential after WAVE 5)
- [ ] Execute test: Create simple .prd with 1 item
  - Verify: Cannot exit session (stop-hook blocks)
  - Expected: "Work items remain in .prd" message
- [ ] Execute test: Delete item from .prd
  - Verify: Can exit session now
  - Expected: "decision: approve" from stop-hook
- [ ] Execute test: Make uncommitted change in git
  - Verify: Cannot exit session (git stop-hook blocks)
  - Expected: "Uncommitted changes exist" message
- [ ] Execute test: Try to use Bash tool (if supported)
  - Verify: Blocked by pre-tool-use-hook
  - Expected: "Use dev execute instead" message
- [ ] Execute complete workflow in plugin:gm:dev:
  - Create .prd with 3 items
  - Create test app file to verify hot reload still works
  - Delete items one by one from .prd
  - Try to exit (should be blocked)
  - Delete all items from .prd
  - Try to exit (should be approved)
  - Witness full workflow completing

## GATE CONDITIONS - ALL MUST BE TRUE BEFORE COMPLETION
- [ ] All hook scripts created and syntactically valid
- [ ] hooks.json configuration file created and valid JSON
- [ ] gm policy integrated into CLAUDE.md (immutable, complete)
- [ ] All 5 hooks execute successfully with proper output format
- [ ] .prd blocking mechanism verified working
- [ ] Git enforcement verified working
- [ ] Pre-tool-use restrictions verified working
- [ ] Session start hook loads gm policy and runs mcp-thorns
- [ ] Prompt submit hook resets verification file
- [ ] Documentation updated with full explanation
- [ ] Real integration test passes (workflow simulation)
- [ ] All code under 200 lines per file
- [ ] No test files on disk (all testing in plugin:gm:dev)
- [ ] No duplicate code between hooks
- [ ] No mocks or fake data
- [ ] No comments beyond what hooks inherited
- [ ] No hardcoded values except timeout constants
- [ ] Ground truth only (real git calls, real file I/O)
